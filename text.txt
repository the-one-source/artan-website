/**
 * Translation and Region Management - Apple.com inspired professional setup
 * Fully IP-detecting, real-time translation, EN toggle override, caching
 */

window.ARTAN_TRANSLATION = (function () {
    const LANGUAGE_STORAGE_KEY = "artan_language";
    const REGION_STORAGE_KEY = "artan_region";
    const REGION_LANGUAGE_MAP = {
        Germany: "de",
        France: "fr",
        "United Kingdom": "en",
        Ireland: "en",
        Denmark: "da",
        Sweden: "sv",
        Norway: "no",
        Finland: "fi",
        Iceland: "is",
        Netherlands: "nl",
        Belgium: "fr",
        Luxembourg: "fr",
        Switzerland: "de",
        Austria: "de",
        Italy: "it",
        Spain: "es",
        Portugal: "pt",
        Greece: "el",
        Poland: "pl",
        Hungary: "hu",
        Romania: "ro",
        Bulgaria: "bg",
        Croatia: "hr",
        Serbia: "sr",
        Slovenia: "sl",
        Slovakia: "sk",
        CzechRepublic: "cs",
        Estonia: "et",
        Latvia: "lv",
        Lithuania: "lt",
        Ukraine: "uk",
        Russia: "ru",
        Belarus: "ru",
        Moldova: "ro",
        Georgia: "ka",
        Armenia: "hy",
        Azerbaijan: "az",
        Turkey: "tr",

        "United States": "en",
        Canada: "en",
        Mexico: "es",
        Brazil: "pt",
        Argentina: "es",
        Chile: "es",
        Peru: "es",
        Colombia: "es",
        Uruguay: "es",
        Paraguay: "es",
        Bolivia: "es",
        Ecuador: "es",
        Venezuela: "es",
        Panama: "es",
        CostaRica: "es",
        Guatemala: "es",
        Honduras: "es",
        Nicaragua: "es",
        Jamaica: "en",
        Bahamas: "en",
        Barbados: "en",
        Belize: "en",
        Bermuda: "en",
        "Puerto Rico": "es",
        "Dominican Republic": "es",
        "Trinidad and Tobago": "en",
        "Cayman Islands": "en",

        India: "hi",
        Pakistan: "ur",
        Bangladesh: "bn",
        SriLanka: "si",
        Nepal: "ne",

        China: "zh",
        Taiwan: "zh",
        HongKong: "zh",
        Macau: "zh",
        Japan: "ja",
        "South Korea": "ko",
        Thailand: "th",
        Vietnam: "vi",
        Indonesia: "id",
        Philippines: "en",
        Malaysia: "ms",
        Singapore: "en",
        Cambodia: "km",
        Laos: "lo",
        Myanmar: "my",
        Brunei: "ms",
        Kazakhstan: "kk",
        Australia: "en",
        "New Zealand": "en",

        Iran: "fa",
        Persia: "fa",
        Israel: "he",
        Egypt: "ar",
        Morocco: "ar",
        Tunisia: "ar",
        Algeria: "ar",
        Nigeria: "en",
        Ghana: "en",
        Kenya: "en",
        Uganda: "en",
        Tanzania: "sw",
        Senegal: "fr",
        Cameroon: "fr",
        Angola: "pt",
        Mozambique: "pt",
        Namibia: "en",
        Botswana: "en",
        "South Africa": "en",
        Jordan: "ar",
        Lebanon: "ar",
        Kuwait: "ar",
        Qatar: "ar",
        Oman: "ar",
        Bahrain: "ar",
        "Saudi Arabia": "ar",
        "United Arab Emirates": "ar"
    };

    let currentLanguage = "en"; // default English
    let currentRegion = "United States"; // default region
    const translationCache = new Map(); // in-memory cache

    // Real-time translation function (free, browser-based Google Translate API)
    const translateText = async (text, targetLang) => {
        if (targetLang === "en") return text; // EN override
        const cacheKey = `${text}_${targetLang}`;
        if (translationCache.has(cacheKey)) return translationCache.get(cacheKey);
        try {
            const encoded = encodeURIComponent(text);
            const response = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=${targetLang}&dt=t&q=${encoded}`);
            const data = await response.json();
            const translated = data[0].map(item => item[0]).join("");
            translationCache.set(cacheKey, translated);
            return translated;
        } catch {
            return text; // fallback English
        }
    };

    // Detect IP and determine region/language
    const detectIP = async () => {
        try {
            const response = await fetch("https://ipapi.co/json/");
            const data = await response.json();
            if (data && data.country_name && REGION_LANGUAGE_MAP[data.country_name]) {
                currentRegion = data.country_name;
                currentLanguage = REGION_LANGUAGE_MAP[currentRegion];
            } else {
                currentRegion = "United States";
                currentLanguage = "en";
            }
        } catch {
            currentRegion = "United States";
            currentLanguage = "en";
        }
    };

    // Apply language dynamically to all [data-i18n-key] elements
    const applyLanguage = async (lang) => {
        currentLanguage = lang;
        localStorage.setItem(LANGUAGE_STORAGE_KEY, lang);
        const nodes = document.querySelectorAll("[data-i18n-key]");
        for (const el of nodes) {
            const originalText = el.dataset.originalText || el.textContent;
            if (!el.dataset.originalText) el.dataset.originalText = originalText; // store original

            // Handle direction-sensitive languages (RTL)
            if (lang === "fa" || lang === "ar" || lang === "ur") {
                el.setAttribute("dir", "rtl");
            } else {
                el.removeAttribute("dir");
            }

            el.textContent = await translateText(originalText, lang);
        }

        if (typeof window.__UPDATE_ANNOUNCEMENT_LANGUAGE__ === "function") {
            window.__UPDATE_ANNOUNCEMENT_LANGUAGE__(lang);
        }

        // Re-apply translation when menu overlay opens (ensures hidden menu items translate)
        document.addEventListener("menuOverlayOpen", async () => {
            const menuNodes = document.querySelectorAll("#menu-overlay [data-i18n-key]");
            for (const el of menuNodes) {
                const originalText = el.dataset.originalText || el.textContent;
                if (!el.dataset.originalText) el.dataset.originalText = originalText;
                el.textContent = await translateText(originalText, currentLanguage);
            }
        });
    };

    // === Announcement Translation Sync (Animated-safe) ===
    window.__UPDATE_ANNOUNCEMENT_LANGUAGE__ = async function (lang) {
        const announcement = document.getElementById("announcement");
        if (!announcement) return;

        const sourceText =
            announcement.dataset.originalText ||
            announcement.dataset.primary ||
            announcement.textContent;

        if (!announcement.dataset.originalText) {
            announcement.dataset.originalText = sourceText;
        }

        const translated = await translateText(sourceText, lang);

        // Always update the animation source text BEFORE animation runs
        announcement.dataset.primary = translated;
        announcement.textContent = translated;
    };

    // Apply region-specific logic (e.g., currency)
    const applyRegion = (region) => {
        currentRegion = region;
        localStorage.setItem(REGION_STORAGE_KEY, region);
        document.querySelectorAll("[data-region-currency]").forEach((el) => {
            if (window.CURRENCY && window.CURRENCY[region]) {
                el.textContent = window.CURRENCY[region];
            }
        });
    };

    // Country overlay interactions
    const initCountryOverlay = () => {
        const overlay = document.getElementById("country-overlay");
        const selector = document.getElementById("country-selector");
        const closeBtn = document.getElementById("country-overlay-close");
        const options = document.querySelectorAll(".country-option");

        if (closeBtn) closeBtn.addEventListener("click", () => {
            overlay.classList.remove("visible");
            setTimeout(() => {
                overlay.classList.add("hidden");
                document.dispatchEvent(new CustomEvent("countryOverlayClose"));
            }, 400);
        });

        if (selector && overlay) selector.addEventListener("click", () => {
            overlay.classList.remove("hidden");
            document.dispatchEvent(new CustomEvent("countryOverlayOpen"));
            setTimeout(() => overlay.classList.add("visible"), 20);
        });

        const nativeNameMap = {
            Germany: "Deutschland",
            France: "France",
            "United Kingdom": "United Kingdom",
            Ireland: "Ireland",
            Denmark: "Danmark",
            Sweden: "Sverige",
            Norway: "Norge",
            Finland: "Suomi",
            Iceland: "Ísland",
            Netherlands: "Nederland",
            Belgium: "Belgique",
            Luxembourg: "Luxembourg",
            Switzerland: "Schweiz",
            Austria: "Österreich",
            Italy: "Italia",
            Spain: "España",
            Portugal: "Portugal",
            Greece: "Ελλάδα",
            Poland: "Polska",
            Hungary: "Magyarország",
            Romania: "România",
            Bulgaria: "България",
            Croatia: "Hrvatska",
            Serbia: "Srbija",
            Slovenia: "Slovenija",
            Slovakia: "Slovensko",
            CzechRepublic: "Česká republika",
            Estonia: "Eesti",
            Latvia: "Latvija",
            Lithuania: "Lietuva",
            Ukraine: "Україна",
            Russia: "Россия",
            Belarus: "Беларусь",
            Moldova: "Moldova",
            Georgia: "საქართველო",
            Armenia: "Հայաստան",
            Azerbaijan: "Azərbaycan",
            Turkey: "Türkiye",

            "United States": "United States",
            Canada: "Canada",
            Mexico: "México",
            Brazil: "Brasil",
            Argentina: "Argentina",
            Chile: "Chile",
            Peru: "Perú",
            Colombia: "Colombia",
            Uruguay: "Uruguay",
            Paraguay: "Paraguay",
            Bolivia: "Bolivia",
            Ecuador: "Ecuador",
            Venezuela: "Venezuela",
            Panama: "Panamá",
            CostaRica: "Costa Rica",
            Guatemala: "Guatemala",
            Honduras: "Honduras",
            Nicaragua: "Nicaragua",
            Jamaica: "Jamaica",
            Bahamas: "Bahamas",
            Barbados: "Barbados",
            Belize: "Belize",
            Bermuda: "Bermuda",
            "Puerto Rico": "Puerto Rico",
            "Dominican Republic": "República Dominicana",
            "Trinidad and Tobago": "Trinidad & Tobago",
            "Cayman Islands": "Cayman Islands",

            India: "भारत",
            Pakistan: "پاکستان",
            Bangladesh: "বাংলাদেশ",
            SriLanka: "ශ්‍රී ලංකා",
            Nepal: "नेपाल",

            China: "中国",
            Taiwan: "台灣",
            HongKong: "香港",
            Macau: "澳門",
            Japan: "日本",
            "South Korea": "대한민국",
            Thailand: "ไทย",
            Vietnam: "Việt Nam",
            Indonesia: "Indonesia",
            Philippines: "Philippines",
            Malaysia: "Malaysia",
            Singapore: "Singapore",
            Cambodia: "កម្ពុជា",
            Laos: "ລາວ",
            Myanmar: "မြန်မာ",
            Brunei: "Brunei",
            Kazakhstan: "Қазақстан",
            Australia: "Australia",
            "New Zealand": "New Zealand",

            Iran: "ایران",
            Persia: "ایران",
            Israel: "ישראל",
            Egypt: "مصر",
            Morocco: "Maroc",
            Tunisia: "تونس",
            Algeria: "الجزائر",
            Nigeria: "Nigeria",
            Ghana: "Ghana",
            Kenya: "Kenya",
            Uganda: "Uganda",
            Tanzania: "Tanzania",
            Senegal: "Sénégal",
            Cameroon: "Cameroun",
            Angola: "Angola",
            Mozambique: "Moçambique",
            Namibia: "Namibia",
            Botswana: "Botswana",
            "South Africa": "South Africa",
            Jordan: "الأردن",
            Lebanon: "لبنان",
            Kuwait: "الكويت",
            Qatar: "قطر",
            Oman: "عُمان",
            Bahrain: "البحرين",
            "Saudi Arabia": "المملكة العربية السعودية",
            "United Arab Emirates": "الإمارات العربية المتحدة"
        };

        options.forEach((btn) => {
            btn.addEventListener("click", async (e) => {
                const country = e.currentTarget.dataset.country;
                if (country) {
                    const regionLang = REGION_LANGUAGE_MAP[country] || "en";
                    applyRegion(country);
                    await applyLanguage(regionLang);
                    const nativeName = nativeNameMap[country] || country;
                    const currentCountryEl = document.getElementById("current-country");
                    if (currentCountryEl) {
                        currentCountryEl.textContent = nativeName;
                    }
                    overlay.classList.remove("visible");
                    setTimeout(() => {
                        overlay.classList.add("hidden");
                        document.dispatchEvent(new CustomEvent("countryOverlayClose"));
                    }, 400);
                }
            });
        });
    };

    // EN toggle override — pure on/off, no region mutation
    const initLanguageToggle = () => {
        const toggle = document.getElementById("language-toggle");
        if (!toggle) return;

        const EN_OVERRIDE_KEY = "artan_en_override";

        const updateToggle = () => {
            const isActive = localStorage.getItem(EN_OVERRIDE_KEY) === "true";
            toggle.classList.toggle("active", isActive);
        };

        toggle.addEventListener("click", () => {
            const isActive = localStorage.getItem(EN_OVERRIDE_KEY) === "true";

            if (isActive) {
                localStorage.removeItem(EN_OVERRIDE_KEY);
                const regionLang = REGION_LANGUAGE_MAP[currentRegion] || "en";
                applyLanguage(regionLang);
            } else {
                localStorage.setItem(EN_OVERRIDE_KEY, "true");
                applyLanguage("en");
            }

            updateToggle();
        });

        // On init, apply EN override if active
        const isActive = localStorage.getItem(EN_OVERRIDE_KEY) === "true";
        if (isActive) {
            applyLanguage("en");
        }

        updateToggle();
    };

    // FIXED INIT FUNCTION
    const init = async () => {
        const sessionKey = "artan_session_active";
        const isHardRefresh = !sessionStorage.getItem(sessionKey);
        sessionStorage.setItem(sessionKey, "true");

        const storedRegion = localStorage.getItem(REGION_STORAGE_KEY);
        const storedLanguage = localStorage.getItem(LANGUAGE_STORAGE_KEY);
        const EN_OVERRIDE_KEY = "artan_en_override";
        const enOverrideActive = localStorage.getItem(EN_OVERRIDE_KEY) === "true";

        if (isHardRefresh || !storedRegion) {
            await detectIP();
            // Ensure IP-detected region/language is applied and stored
            localStorage.setItem(REGION_STORAGE_KEY, currentRegion);
            localStorage.setItem(LANGUAGE_STORAGE_KEY, currentLanguage);
        } else {
            currentRegion = storedRegion;
            currentLanguage = storedLanguage || (REGION_LANGUAGE_MAP[storedRegion] || "en");
        }

        if (enOverrideActive) {
            await applyLanguage("en");
        } else {
            await applyLanguage(currentLanguage);
        }
        applyRegion(currentRegion);
        initCountryOverlay();
        initLanguageToggle();
    };

    return { init, applyLanguage, applyRegion };
})();

document.addEventListener("DOMContentLoaded", () => {
    if (window.ARTAN_TRANSLATION && typeof window.ARTAN_TRANSLATION.init === "function") {
        window.ARTAN_TRANSLATION.init();
    }
    document.addEventListener("announcementFinished", () => {
        const announcement = document.getElementById("announcement");
        const enter = document.getElementById("enter-button");

        if (announcement) {
            announcement.classList.add("hidden");
        }

        if (enter) {
            enter.classList.add("visible");
        }
    });
});